```typescript
import React, { useState, useEffect } from 'react';
import { SpellIdentityCard } from './components/SpellIdentityCard';
import { SpellMetadataCard } from './components/SpellMetadataCard';
import { StatsGrid } from './components/StatsGrid';
import { ActionsBar } from './components/ActionsBar';
import type { Spell } from '../../balancing/spellTypes';
import { createEmptySpell } from '../../balancing/spellTypes';
import {
    calculateSpellBudget,
    getStatWeight,
    getStatDescription,
    isMalus,
    SPELL_CONFIG,
    updateConfig,
    updateRange,
    getBaselineSpell
} from '../../balancing/spellBalancingConfig';
import { upsertSpell } from '../../balancing/spellStorage';

export const SpellCreation: React.FC = () => {
    // --- State Management ---
    const [statSteps, setStatSteps] = useState<Record<string, Array<{ value: number; weight: number }>>>({});
    const [spell, setSpell] = useState<Spell>(createEmptySpell());
    const [customWeights, setCustomWeights] = useState<Record<string, number>>({});
    const [customBaselines, setCustomBaselines] = useState<Partial<Spell>>({});
    const [targetBudget, setTargetBudget] = useState<number>(0);
    const [collapsedStats, setCollapsedStats] = useState<Set<string>>(() => {
        const saved = localStorage.getItem('spellCollapsedStats');
        if (saved) {
            try {
                return new Set(JSON.parse(saved));
            } catch {
                return new Set();
            }
        }
        return new Set();
    });

    // --- Initialization ---
    useEffect(() => {
        setCustomBaselines(getBaselineSpell());
    }, []);

    // --- Stat Step Logic ---
    const getStatSteps = (field: string) => statSteps[field] || [{ value: (spell as any)[field] || 0, weight: getStatWeight(field) }];

    const updateStatStep = (field: string, idx: number, step: { value: number; weight: number }) => {
        setStatSteps(prev => {
            const steps = [...(prev[field] || [{ value: (spell as any)[field] || 0, weight: getStatWeight(field) }])];
            steps[idx] = step;
            return { ...prev, [field]: steps };
        });
        // Update the spell field if it's the first step (simplified logic for now)
        if (idx === 0) {
            updateField(field as keyof Spell, step.value);
        }
    };

    const addStatStep = (field: string, idx: number) => {
        setStatSteps(prev => {
            const steps = [...(prev[field] || [{ value: (spell as any)[field] || 0, weight: getStatWeight(field) }])];
            steps.splice(idx + 1, 0, { value: 0, weight: getStatWeight(field) });
            return { ...prev, [field]: steps };
        });
    };

    const removeStatStep = (field: string, idx: number) => {
        setStatSteps(prev => {
            const steps = [...(prev[field] || [{ value: (spell as any)[field] || 0, weight: getStatWeight(field) }])];
            if (steps.length > 1) steps.splice(idx, 1);
            return { ...prev, [field]: steps };
        });
    };

    // --- Core Logic ---
    const cost = calculateSpellBudget(
        spell,
        Object.keys(customWeights).length > 0 ? customWeights : undefined,
        Object.keys(customBaselines).length > 0 ? customBaselines : undefined
    );
    const balance = cost - targetBudget;

    const updateField = (field: keyof Spell, value: any) => {
        setSpell(prev => ({ ...prev, [field]: value }));
    };

    const handleSave = () => {
        const minimalSpell: Partial<Spell> = { ...spell };
        // Clean up undefined/default values
        Object.keys(minimalSpell).forEach(key => {
            if ((minimalSpell as any)[key] === undefined || (minimalSpell as any)[key] === 0) {
                delete (minimalSpell as any)[key];
            }
        });
        const finalSpell = { ...minimalSpell, spellLevel: Math.round(cost) } as Spell;
        upsertSpell(finalSpell);
        alert(`Spell "${finalSpell.name}" saved!`);
        setSpell(createEmptySpell());
        setCustomWeights({});
    };

    const handleReset = () => {
        setSpell(createEmptySpell());
        setCustomWeights({});
        setStatSteps({});
    };

    const toggleCollapse = (field: string) => {
        setCollapsedStats(prev => {
            const next = new Set(prev);
            if (next.has(field)) {
                next.delete(field);
            } else {
                next.add(field);
            }
            localStorage.setItem('spellCollapsedStats', JSON.stringify(Array.from(next)));
            return next;
        });
    };

    // --- Configuration ---
    const coreStats = ['effect', 'eco', 'dangerous'];
    const advancedStats = ['scale', 'precision'];
    const optionalStats = ['aoe', 'cooldown', 'range', 'priority', 'manaCost'];

    return (
        <div className="h-full flex flex-col bg-gradient-to-br from-slate-950 to-slate-900 text-white overflow-hidden">
            {/* Header */}
            <div className="flex-none p-4 border-b border-white/10 bg-black/20 backdrop-blur-sm flex justify-between items-center z-10">
                <div className="absolute w-96 h-96 bg-purple-500/10 rounded-full blur-3xl top-10 -left-20 animate-pulse" />
                <div className="absolute w-96 h-96 bg-blue-500/10 rounded-full blur-3xl bottom-10 -right-20 animate-pulse" style={{ animationDelay: '1s' }} />
                <div className="absolute top-0 left-0 w-full h-full bg-[url('/grid.svg')] opacity-10"></div>
                
                <h1 className="text-3xl font-bold text-white drop-shadow-[0_0_8px_rgba(168,85,247,0.6)] relative z-10">ðŸ”® Spell Creation</h1>
                
                <div className="flex items-center gap-4 bg-black/40 px-4 py-2 rounded-lg border border-white/10 backdrop-blur-md relative z-10">
                    <span className="text-sm uppercase tracking-wider text-gray-400 font-semibold">Balance</span>
                    <span className="text-2xl font-bold font-mono drop-shadow-[0_0_8px_currentColor] ${balance === 0 ? 'text-emerald-400' : 'text-red-400'}">
                        {balance > 0 ? '+' : ''}{balance.toFixed(2)}
                    </span>
                </div>
            </div>

            <div className="flex-grow overflow-y-auto p-4 relative">
                <div className="max-w-7xl mx-auto relative z-10">
                    {/* Top Section: Identity & Stats */}
                    <div className="flex flex-col lg:flex-row gap-6 mb-8">
                        {/* Left: Identity Card */}
                        <div className="w-full lg:w-1/3">
                            <SpellIdentityCard
                                spell={spell}
                                updateField={updateField}
                                targetBudget={targetBudget}
                                setTargetBudget={setTargetBudget}
                            />
                        </div>

                        {/* Right: Stats Grid */}
                        <div className="w-full lg:w-2/3">
                            <StatsGrid
                                coreStats={coreStats}
                                advancedStats={advancedStats}
                                optionalStats={optionalStats}
                                getStatDescription={getStatDescription}
                                isMalus={isMalus}
                                collapsedStats={collapsedStats}
                                toggleCollapse={toggleCollapse}
                                getStatSteps={getStatSteps}
                                updateStatStep={updateStatStep}
                                addStatStep={addStatStep}
                                removeStatStep={removeStatStep}
                            />
                        </div>
                    </div>

                    {/* Visual separator */}
                    <div className="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent my-8" />

                    {/* Bottom Section: Metadata */}
                    <SpellMetadataCard spell={spell} updateField={updateField} />

                    <div className="h-8" /> {/* Spacer */}

                    <ActionsBar onReset={handleReset} onSave={handleSave} balance={balance} />
                </div>
            </div>
        </div>
    );
};
```
